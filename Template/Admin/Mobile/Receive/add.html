<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>库存管理——领用查询——新增</title>

		<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/amazeui.min.css" />
		<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/publicsty.css" />
		<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/asset_set.css" />
		<link rel="stylesheet" href="__PUBLIC__/css/inventory.css" />
		<!--日期控件依赖的css-->
		<link href="__CSS__/datecss/mobiscroll_002.css" rel="stylesheet" type="text/css">
		<link href="__CSS__/datecss/mobiscroll.css" rel="stylesheet" type="text/css">
		<link href="__CSS__/datecss/mobiscroll_003.css" rel="stylesheet" type="text/css">
		<!--日期控件依赖的css-->
		<!--日期控件依赖的js-->
	<script type="text/javascript" src="__PUBLIC__/js/jquery.min.js" ></script>
		<script src="__JS__/datejs/mobiscroll_002.js" type="text/javascript"></script>
		<script src="__JS__/datejs/mobiscroll_004.js" type="text/javascript"></script>
		<script src="__JS__/datejs/mobiscroll.js" type="text/javascript"></script>
		<script src="__JS__/datejs/mobiscroll_003.js" type="text/javascript"></script>
		<script src="__JS__/datejs/mobiscroll_005.js" type="text/javascript"></script>
		<script src="__JS__/sercher.js" type="text/javascript"></script>
		<!--日期控件依赖的js-->

	
	
	<script type="text/javascript" src="__PUBLIC__/js/sercher.js"></script>
		<script src="__PUBLIC__/js/ronshn.js" type="text/javascript" charset="utf-8"></script>
		<script src="__PUBLIC__/js/layer/layer.js" type="text/javascript" charset="utf-8"></script>
	</head>

	<body>
		<include file="Public/header" />
		<ol class="am-breadcrumb">
		  <li><a href="<?php echo U('Menus/stock')?>">库存管理</a></li>
		  <li><a href="<?php echo U('index')?>">领用查询</a></li>
		  <li class="am-active">新增</li>
		  <a href="javascript:history.go(-1)" class="callback_btn">返回</a>
		</ol>

		<form class="am-form am-form-horizontal">
			<div class="form_color_white">
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">单号</label>
					<div class="am-u-sm-8">
						<input type="text" id="doc-ipt-3 sys_input" ni-o="ordersn" placeholder="自动生成" value="<?php echo $order_sn;?>" disabled="disabled">
					</div>
				</div>
				<div class="am-form-group">
					<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">日期</label>
					<div class="am-u-sm-8">
						<input name="appDate" id="appDate" type="text" placeholder="请选择日期" ni-o="date" value="<?php echo date('Y-m-d',$timedate)?>">
					</div>
				</div>
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">申请人</label>
					<div class="am-u-sm-8">
						<input type="text" ni-o="applyer" id="doc-ipt-3 sys_input" placeholder="请输入" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
					</div>
				</div>
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">领用部门</label>
					<div class="am-u-sm-8">
						<select class="position-department-sele bgimg-select" ni-o="depart" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
						<option value="">选择部门</option>
						<?php foreach($list_dep as $v):?>
						<option <?php if($depart==$v['depart_name']):?>selected="selected"<?php endif;?> value="<?php echo $v['id']?>"><?php echo $v['fullname']?></option>
						<?php endforeach;?>
					</select>
					</div>
				</div>
				<?php if($is_supper==1):?>
				<div class="am-form-group">
					<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">所属单位</label>
					<div class="am-u-sm-8">
					<select ni-o="org_id" class="position-department-sele bgimg-select" id='departmentClickBtn'>
									<option value="">选择所属单位</option>
									<?php foreach($departlist as $v):?>
									<option <?php if($did==$v['id']):?>selected="selected"<?php endif;?>value="<?php echo $v['id']?>"><?php echo $v['depart_name']?></option>
								<?php endforeach;?>
								</select>
					</div>
				</div>
				<?php endif;?>
			</div>
			
			<div id="goods_add_box" class="bord_top_ddd m-box">
				<div class="form_color_white goods_add_box m-sub">
					<div class="am-form-group">
						<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">物品名称</label>
						<div class="am-u-sm-8">
							<input type="text" id="doc-ipt-3 sys_input" field="assets_name" placeholder="请输入" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
						</div>
					</div>
					<div class="am-form-group">
						<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">物品ID</label>
						<div class="am-u-sm-8">
							<input type="text" id="doc-ipt-pwd-2" field="id" placeholder="请输入" disabled="disabled" name="IDinfo">
						</div>
					</div>
					<div class="am-form-group">
						<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">规格型号</label>
						<div class="am-u-sm-8">
							<input type="text" id="doc-ipt-pwd-2" field="spec" disabled="disabled" placeholder="请输入">
						</div>
					</div>
	
					<div class="am-form-group">
						<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">数量</label>
						<div class="am-u-sm-8">
							<input type="text" id="doc-ipt-3 sys_input" name="number" onblur="numberBlur($(this))" value="1" onkeyup="value=value.replace(/[^\d]/g,'')" field="number" placeholder="请输入" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?> >
						</div>
					</div>
					<div class="am-form-group" style="display: none;">
						<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">小计</label>
						<div class="am-u-sm-8">
							<input type="text" id="doc-ipt-3 sys_input" name="pricetotal" value="" onkeyup="value=value.replace(/[^\d]/g,'')"  placeholder="请输入" disabled="disabled" field="price_total">
						</div>
					</div>
					<div class="am-form-group">
						<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">单价</label>
						<div class="am-u-sm-8">
							<div class="am-form-group am-form-select">
								<input type="number" onblur="totalBlur($(this))" name="total" id="doc-ipt-pwd-2" field="price" placeholder="请输入"  <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
							</div>
							
							<?php if($did==''&&$is_supper==1):?>
							<?php else:?>
								<span id="delete_goods" onclick="delete_goods(this)">删除</span>
							<?php endif;?>
						</div>
					</div>
				</div>
			</div>
			<?php if($did==''&&$is_supper==1):?>
				<?php else:?>
			<div id="goods_add_btn" class="bord_top_ddd bord_no_bottom">
				<img src="__PUBLIC__/images/jia.png" />
					<span>增加物品</span>
			</div>
			<?php endif;?>
		
			
			<div id="audit_add_box">
				<div class="audit_add_box">
					<div class="am-form-group">
						<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">审核</label>
						<div class="am-u-sm-8">
							<div class="am-form-group am-form-select">
									<select class="goods_select" ni-o="department_id" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
								<option value="">选择审核人</option>
								<volist name="list_dep" id='ld'>
									<option value="{$ld.id}">{$ld.fullname}</option>
								</volist>
								</select>
							</div>
							<?php if($did==''&&$is_supper==1):?>
							<?php else:?>
								<span id="delete_asset" onclick="delete_aduit(this)">删除</span>
							<?php endif;?>
							
						</div>
					</div>
				</div>
			</div>
			
			<?php if($did==''&&$is_supper==1):?>
				<?php else:?>
			<div id="audit_add_btn">
				<img src="__PUBLIC__/images/jia.png" />
					<span>增加审核</span>
			</div>
			<?php endif;?>
				<div id="audit_add_box" class="bord_no_bottom">
				<div class="audit_add_box">
					<div class="am-form-group">
						<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">合计</label>
						<div class="am-u-sm-8">
							<input type="number" id="doc-ipt-pwd-2" placeholder="自动生成"  ni-o="total_price" name="total_price" disabled="disabled">
						</div>
					</div>
					<div class="am-form-group">
						<label for="doc-ipt-pwd-2" class="am-u-sm-4 am-form-label sys_num">备注</label>
						<div class="am-u-sm-8">
							<input type="number" id="doc-ipt-pwd-2" placeholder="可不填"  ni-o="re_remark" <?php if($did==''&&$is_supper==1):?>disabled="disabled"<?php endif;?>>
						</div>
					</div>
				</div>
			</div>
		<?php if($did==''&&$is_supper==1):?>
					<a href="{:U('Weixiu/index')}"><input type="button" class="back_btn" value="返回"></input></a>
				<?php else:?>
			<input type="button" class="back_btn" value="提交" poster="ni" action="<?php echo U('add')?>"></input>
				<?php endif;?>
		</form>
	</body>

	<script type="text/javascript">
	$(function(){
					var weburl="/Admin/Receive/goodsList?org_id={$did}";
			    tab = new Sercher({box:'.m-box',sub:'.m-sub',inputer:'assets_name',submit:'ni',url:weburl}).add();
			    var currYear = (new Date()).getFullYear();	
			var opt={};
			opt.date = {preset : 'date'};
			opt.datetime = {preset : 'datetime'};
			opt.time = {preset : 'time'};
			opt.default = {
				theme: 'android-ics light', //皮肤样式
		        display: 'modal', //显示方式 
		        mode: 'scroller', //日期选择模式
				dateFormat: 'yyyy-mm-dd',
				lang: 'zh',
				showNow: true,
				nowText: "今天",
		        startYear: currYear - 10, //开始年份
		        endYear: currYear + 10 //结束年份
			};
		  	$("#appDate").mobiscroll($.extend(opt['date'], opt['default']));
			    
	})
	function numberBlur(_this){
		var NumVal=_this.val();
  	var totalVal=Number(_this.parents('.m-sub').find("input[name='total']").val()) 
		var pricetotalVal=_this.parents('.m-sub').find("input[name='pricetotal']")
  	var total_priceVal=NumVal*totalVal
  	pricetotalVal.val(total_priceVal.toFixed(2))
  	SumPrice(_this)
	}
	function totalBlur(_this){
		var totalVal=_this.val();
  	var NumVal=Number(_this.parents('.m-sub').find("input[name='number']").val()) 
		var pricetotalVal=_this.parents('.m-sub').find("input[name='pricetotal']")
  	var total_priceVal=NumVal*totalVal
  	pricetotalVal.val(total_priceVal.toFixed(2))
  	SumPrice(_this)
	}
function SumPrice(_this){
		var IDinfo=_this.parents('.m-sub').find("input[name='IDinfo']").val();
		if(IDinfo>0){
				var total = 0;
				var inpt = $("input[name='pricetotal']");
				for(var i=0;i<inpt.length;i++){
					total+=Number(inpt.eq(i).val());
				}
				$("input[name='total_price']").val(total);
			}
			
		}
		//日期
        $(function () {
				$('#departmentClickBtn').change(function(event) {
				var id=$(this).val();
				var url="/Admin/Receive/add?did="+id;
				window.location.href=url;
				});

        	//增加审核
			$("#audit_add_btn").click(function() {
				var html = '<div class="audit_add_box">' +
					'<div class="am-form-group">' +
					'<label for="doc-ipt-3" class="am-u-sm-4 am-form-label sys_num">审核</label>' +
					'<div class="am-u-sm-8">' +
					'<div class="am-form-group am-form-select">' +
						'<select class="goods_select" ni-o="department_id">' +
					'<option value="">选择审核人</option>' +
					<?php foreach($list_dep as $v):?>
					'<option value="{$v['id']}">{$v['fullname']}</option>' +
					<?php endforeach;?>
					'</select>' +
					'</div>' +

					'<span id="delete_asset" onclick="delete_aduit(this)">删除</span>' +
					'</div>' +
					'</div>' +
					'</div>';
				$("#audit_add_box").append(html);
			});
			
			//增加物品

		});
	/*************************************************\
			 * 点击增加物品按钮——添加物品
			\*************************************************/
			$("#goods_add_btn").click(function(){
				tab.add();
			});
        	/*************************************************\
		 * 删除物品
		\*************************************************/
		// function delete_goods(o){

		// 	tab.del(o);
		// }
		//删除审核
		function delete_aduit(d){
			if($('.audit_add_box').length==2){
				return;
			}
			$(d).closest(".audit_add_box").remove();
		}
		//删除物品
		function delete_goods(goods_d){
			if($('.goods_add_box').length==1){
					return;
			}
			// $("input[name='number']").focus();
			var inpt = $("input[name='number']");
		  inpt[0].focus();
			$(goods_d).closest(".goods_add_box").remove();
		}
    </script>
</html>